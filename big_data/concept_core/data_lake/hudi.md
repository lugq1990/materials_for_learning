## Hudi


![Hudi arch](https://hudi.apache.org/cn/assets/images/hudi-lake-overview-e39f80337517a0a1999d8eb5cd0ac965.png)


### hudi的架构是如何的

Apache Hudi（Hadoop Upserts Deletes and Incrementals）是一个开源的数据湖解决方案，用于在大规模数据湖中实现增量数据处理、数据变更跟踪和实时分析等功能。下面是 Hudi 的高层架构概述：

1. **数据模型**：
   - Hudi 将数据分为三种类型：基础数据文件（Base Files）、变更数据文件（Delta Files）、快照数据文件（Snapshot Files）。基础数据文件存储原始数据，变更数据文件存储数据的增量变更，快照数据文件存储数据的历史版本。

2. **存储层**：
   - Hudi 使用分布式文件系统（如HDFS、S3等）作为数据存储层。基础数据文件、变更数据文件和快照数据文件都存储在分布式文件系统中，以支持大规模数据存储和处理。

3. **元数据管理**：
   - Hudi 使用元数据表（Metadata Table）来管理数据的元数据信息，包括表的结构、分区信息、数据文件的版本和位置等。元数据表可以存储在关系型数据库（如MySQL、Hive Metastore）中，也可以使用分布式存储系统（如HBase）进行存储。

4. **写入流程**：
   - 在写入数据时，Hudi 将数据分为小批次（Batch）或单个记录（Record），并将数据写入到基础数据文件和变更数据文件中。写入数据时，Hudi 会生成唯一的文件ID，并将文件ID和数据记录的唯一标识（如主键）进行关联。

5. **读取流程**：
   - 在读取数据时，Hudi 可以根据用户指定的查询条件，从基础数据文件、变更数据文件和快照数据文件中读取数据，并将数据合并成一个逻辑视图返回给用户。用户可以通过查询条件来过滤数据和获取指定时间点的数据。

6. **数据操作**：
   - Hudi 支持数据的插入（Insert）、更新（Upsert）、删除（Delete）和查询（Query）等操作。用户可以通过 Hudi 提供的 API 或 SQL 接口来对数据进行操作和查询。

7. **增量处理**：
   - Hudi 提供了增量数据处理和变更跟踪的功能，可以实时捕获数据的变更，并将变更写入到变更数据文件中。增量数据处理可以帮助用户实时更新数据，并保持数据的一致性和可靠性。

总的来说，Apache Hudi 的架构设计旨在支持大规模数据湖中的实时数据处理和分析需求，提供了灵活、高效和可靠的数据湖解决方案。


### hudi的COPY_ON_WRITE and MERGE_ON_READ的区别

Hudi 中的 COPY_ON_WRITE 和 MERGE_ON_READ 是两种不同的数据存储和更新策略，它们的主要区别在于数据的写入和更新方式：

1. **COPY_ON_WRITE**：
   - COPY_ON_WRITE 是指在写入新数据时，会创建一个新的数据文件，并将新的数据写入到这个文件中。原有的数据文件保持不变，不会被修改。因此，写入新数据时会占用更多的磁盘空间，但不会影响到原有的数据文件。
   - COPY_ON_WRITE 策略适合于数据更新比较频繁，且对磁盘空间要求不是很敏感的场景。由于原有数据文件不会被修改，因此可以保证数据的一致性和可靠性。

2. **MERGE_ON_READ**：
   - MERGE_ON_READ 是指在读取数据时，会在后台进行数据合并（Merge）操作。当读取数据时，Hudi 会检查数据文件的版本，并将不同版本的数据合并成一个逻辑视图返回给用户。合并后的数据视图可以包含最新的数据和历史数据。
   - MERGE_ON_READ 策略适合于数据写入频率较低，但需要频繁读取和查询历史数据的场景。由于数据合并操作是在读取时进行的，因此可以减少写入时的磁盘空间占用和数据复制的开销。

总的来说，COPY_ON_WRITE 策略适合于频繁写入数据的场景，而 MERGE_ON_READ 策略适合于频繁读取历史数据的场景。你可以根据具体的业务需求和性能要求选择合适的存储和更新策略。


### 那如果创建一个试图的话，那不是每次用户做一次查询，都需要对数据进行整合？这是一个高效的方式么

在读取数据时，Hudi 确实需要将基础数据文件、变更数据文件和快照数据文件合并成一个逻辑视图，以满足用户的查询需求。这种方式可能会导致一些性能开销，特别是在数据量较大或查询条件较复杂的情况下。但是，Hudi 提供了一些机制来优化查询性能：

1. **增量合并（Incremental Merge）**：Hudi 支持增量合并操作，可以定期或在需要时将新的变更数据合并到快照数据文件中，以减少每次查询时的数据合并开销。通过增量合并，可以将变更数据的影响逐步应用到快照数据文件中，使得查询时只需要对快照数据文件进行合并操作，减少了数据合并的开销。

2. **索引和分区优化**：Hudi 可以根据用户指定的查询条件和数据分区信息，利用索引和分区信息来加速数据访问和查询。通过合理设计数据的索引和分区策略，可以将数据的查询范围和数据文件的数量限制在较小的范围内，从而提高查询性能。

3. **数据缓存**：Hudi 可以利用缓存机制来缓存查询结果或热点数据，减少重复查询时的数据合并开销。通过合理设置缓存大小和过期策略，可以在一定程度上提高查询性能。

虽然每次查询都需要对数据进行合并可能会带来一定的性能开销，但通过合理设计和优化查询策略、数据组织方式和缓存机制，可以有效减少这种开销，提高查询性能和响应速度。