## zookeeper basic

**[zookeeper starter: official website](https://zookeeper.apache.org/doc/current/zookeeperStarted.html)**


## ZooKeeper是什么？核心概念简述

**ZooKeeper** 是一个开源的分布式协调服务，为大型分布式计算提供一致性服务。它可以为分布式应用提供诸如同步服务、配置维护、命名服务等功能。

### ZooKeeper的核心概念

* **ZNode:** ZooKeeper中的数据存储单元，类似于文件系统中的节点。每个ZNode可以存储数据，并拥有子节点。
* **层次命名空间:** ZooKeeper的数据模型是一个分层的命名空间，类似于文件系统的目录结构。
* **数据一致性:** ZooKeeper保证了客户端对ZooKeeper的读写操作具有顺序一致性，即所有的客户端看到的数据更新是相同的，而且是全局有序的。
* **顺序一致性:** 客户端发送的更新请求按照全局有序的方式被处理。
* **原子性:** 更新操作要么全部成功，要么全部失败。

### ZooKeeper的作用

* **配置管理:** 将系统的配置信息存储在ZooKeeper中，实现集中化管理和动态更新。
* **命名服务:** 为分布式系统中的服务提供唯一的命名，实现服务发现。
* **集群管理:** 用于管理集群中的服务器，实现负载均衡、故障转移等功能。
* **分布式锁:** 提供分布式锁的实现，保证共享资源的互斥访问。
* **队列:** 实现分布式的队列，用于任务调度等场景。

### ZooKeeper的工作原理

ZooKeeper采用**ZAB协议**（ZooKeeper Atomic Broadcast）来保证数据的一致性。ZAB协议是一个基于原子广播的协议，它保证了所有客户端对ZooKeeper的更新操作都能够被所有服务器原子地广播。

* **Leader选举:** ZooKeeper集群中只有一个Leader，负责处理所有的写操作。Leader选举通过Zab协议实现。
* **数据同步:** Leader将写操作广播给所有的Follower，Follower收到写操作后更新自己的数据。
* **数据一致性:** ZooKeeper通过版本号来保证数据的一致性。

### ZooKeeper的优势

* **高可用性:** ZooKeeper集群中的多个服务器可以保证系统的可用性。
* **顺序一致性:** ZooKeeper保证了客户端对ZooKeeper的读写操作具有顺序一致性。
* **可靠性:** ZooKeeper的数据持久化到磁盘，保证了数据的可靠性。
* **简单易用:** ZooKeeper提供了简单易用的API，方便开发者使用。

### 总结

ZooKeeper是一个强大的分布式协调服务，它为分布式系统提供了可靠的同步服务和配置管理。通过ZooKeeper，可以实现分布式系统的各种高级功能，如分布式锁、集群管理等。

### 常见问题

* **ZooKeeper和etcd的区别是什么？**
* **ZooKeeper的性能瓶颈在哪里？**
* **ZooKeeper在哪些场景下应用比较广泛？**

**如果您想更深入地了解ZooKeeper，可以从以下方面入手：**

* **ZooKeeper的安装和配置**
* **ZooKeeper的API使用**
* **ZooKeeper的典型应用场景**
* **ZooKeeper的高级特性**

**您想了解ZooKeeper的哪个方面呢？** 


### zookeeper如何克服单点故障

Zookeeper 通过以下方式克服单点故障：

1. **集群配置（Ensemble）**：Zookeeper 运行在一个集群中，而不是单个节点上。这个集群被称为 ensemble。通常，ensemble 至少由三台机器组成，以保证高可用性。如果一个节点出现故障，其他节点仍然可以继续提供服务。

2. **复制和同步**：Zookeeper 将数据复制到集群中的所有节点。每个节点都有相同的数据副本，并且通过选举机制保持数据的一致性。当客户端写入数据时，Zookeeper 会确保将数据写入到多数节点（quorum）后，才返回成功响应。这种机制保证了即使部分节点发生故障，数据仍然是安全的。

3. **领导者选举**：Zookeeper 使用一种称为 ZAB（Zookeeper Atomic Broadcast）协议来进行领导者选举和保证数据一致性。当集群启动时，会选举出一个领导者（Leader）。Leader 负责处理所有写请求，并将更新广播给所有其他节点（称为追随者，Follower）。如果 Leader 节点发生故障，剩余的节点会重新进行选举，选出新的 Leader。

4. **数据恢复**：当一个节点宕机并恢复后，它会从其他节点获取最新的数据，并进行同步，确保数据一致性。这种机制使得节点可以快速恢复并重新加入集群。

5. **会话超时和重连机制**：Zookeeper 客户端与服务器之间通过会话保持连接。如果连接断开，客户端会尝试重新连接到集群中的其他节点。客户端会自动处理连接的失败和重试，从而保证应用程序的高可用性。

### 实际部署中的高可用性策略

为了在实际部署中实现高可用性，以下是一些常见的策略：

- **奇数个节点**：在集群中使用奇数个节点（例如 3、5 或 7 个节点）。这种配置有助于在节点发生故障时，保持 quorum（多数）节点的可用性。
- **地理分布**：将节点分布在不同的数据中心或不同的地理位置，以防止由于单一数据中心故障导致的集群不可用。
- **监控和警报**：设置 Zookeeper 的监控和警报系统，以便在节点出现故障时，能够及时发现并进行处理。
- **定期备份**：定期备份 Zookeeper 数据，以防止数据丢失。

通过这些机制和策略，Zookeeper 能够有效地克服单点故障，保证系统的高可用性和数据的一致性。


## 如何形象的理解zookeeper

ZooKeeper 作为一个分布式协调服务，主要用于保存 **分布式系统中的元数据**，而不是存储业务数据。这些元数据通常是用来描述系统状态、配置信息、锁信息等，以便于分布式系统中的各个节点之间进行协调和通信。

**ZooKeeper 保存的典型数据包括：**

* **配置信息：** 比如分布式系统的配置文件、参数等。
* **状态信息：** 各个节点的状态信息，如在线状态、故障状态等。
* **锁信息：** 用于实现分布式锁，保证对共享资源的互斥访问。
* **队列信息：** 实现分布式队列，用于任务调度等。
* **命名服务信息：** 为分布式系统中的服务提供唯一的命名。

**ZooKeeper 不适合保存大量业务数据的原因：**

* **性能瓶颈：** ZooKeeper 的设计目标是提供高可用性和一致性，对于大规模数据的存储和查询性能较差。
* **数据模型限制：** ZooKeeper 的数据模型是层次化的，不适合存储复杂结构的业务数据。
* **成本较高：** 将业务数据存储在 ZooKeeper 中会增加存储成本。

**所以，ZooKeeper 更适合作为分布式系统的"大脑"，负责协调和管理整个系统的运行状态，而不是作为"存储库"来存储大量的业务数据。**

**总结一下，ZooKeeper 主要保存以下几类数据：**

* **元数据：** 描述系统状态、配置信息等。
* **控制信息：** 用于控制分布式系统的运行，如锁、队列等。
* **命名信息：** 为分布式系统中的服务提供唯一标识。

**而对于大量的业务数据，更适合使用专门的分布式存储系统，如 HBase、Cassandra 等。**

**举个例子：**

在一个分布式消息队列系统中，ZooKeeper 可以用来存储：

* **Broker 的状态信息：** 每个 Broker 的地址、是否可用等。
* **Topic 的配置信息：** 每个 Topic 的分区数、副本数等。
* **消费者组的信息：** 每个消费者组的订阅关系等。

而消息队列本身的数据（即消息内容）则存储在 Kafka 等消息队列系统中。

**希望这个解释能帮助您更好地理解 ZooKeeper 的作用。**



## 形象地理解ZooKeeper：一个分布式系统的“大脑”

**ZooKeeper**，你可以把它想象成一个分布式系统的“大脑”。这个“大脑”负责协调和管理整个系统中各个节点的行为，确保它们能够协同工作，达成一致。

### 为什么要有ZooKeeper？

* **分布式系统复杂性高：** 在分布式系统中，多个节点同时工作，它们之间需要协调，比如选举一个Leader，分配任务，同步状态等。
* **保证数据一致性：** 在分布式环境下，如何保证多个节点的数据一致性是一个很大的挑战。ZooKeeper可以提供强一致性保证。
* **提高系统可用性：** ZooKeeper可以实现故障转移，当某个节点出现故障时，其他节点可以接替它的工作。

### ZooKeeper到底做了什么？

* **配置管理：** 将系统的配置信息存储在ZooKeeper中，实现集中化管理和动态更新。
* **命名服务：** 为分布式系统中的服务提供唯一的命名，实现服务发现。
* **集群管理：** 用于管理集群中的服务器，实现负载均衡、故障转移等功能。
* **分布式锁：** 提供分布式锁的实现，保证共享资源的互斥访问。
* **队列：** 实现分布式的队列，用于任务调度等场景。

### ZooKeeper的工作原理（简单版）

你可以把ZooKeeper想象成一个巨大的树形结构，每个节点（Znode）都可以存储数据。这个树形结构就像一个白板，所有节点都可以在这里写写画画，但要保证大家看到的都是最新的信息。

* **Leader选举：** ZooKeeper集群中只有一个Leader，负责处理所有的写操作。Leader选举的过程就像开会选举班长一样，大家投票选出最合适的那个。
* **数据同步：** Leader将写操作广播给所有的Follower，Follower收到写操作后更新自己的数据。
* **数据一致性：** ZooKeeper通过版本号来保证数据的一致性。

### ZooKeeper的优势

* **高可用性：** ZooKeeper集群中的多个服务器可以保证系统的可用性。
* **顺序一致性：** ZooKeeper保证了客户端对ZooKeeper的读写操作具有顺序一致性。
* **可靠性：** ZooKeeper的数据持久化到磁盘，保证了数据的可靠性。
* **简单易用：** ZooKeeper提供了简单易用的API，方便开发者使用。

### 总结

ZooKeeper就像一个指挥官，它告诉分布式系统中的各个节点应该做什么，怎么去做，从而保证整个系统的稳定运行。

### 常见问题

* **ZooKeeper和etcd的区别是什么？**
* **ZooKeeper的性能瓶颈在哪里？**
* **ZooKeeper在哪些场景下应用比较广泛？**

**如果你想更深入地了解ZooKeeper，可以从以下方面入手：**

* **ZooKeeper的安装和配置**
* **ZooKeeper的API使用**
* **ZooKeeper的典型应用场景**
* **ZooKeeper的高级特性**

**希望这个形象的比喻能帮助你更好地理解ZooKeeper！**

**你还有其他关于ZooKeeper的问题吗？**

